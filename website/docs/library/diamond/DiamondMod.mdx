---
sidebar_position: 1
title: "DiamondMod"
description: "Internal functions and storage for diamond proxy"
gitSource: "https://github.com/Perfect-Abstractions/Compose/tree/main/src/diamond/DiamondMod.sol"
---

import DocSubtitle  from '@site/src/components/docs/DocSubtitle';
import Badge from '@site/src/components/ui/Badge';
import Callout from '@site/src/components/ui/Callout';
import CalloutBox from '@site/src/components/ui/CalloutBox';
import Accordion, { AccordionGroup } from '@site/src/components/ui/Accordion';
import PropertyTable from '@site/src/components/api/PropertyTable';
import ExpandableCode from '@site/src/components/code/ExpandableCode';
import CodeShowcase from '@site/src/components/code/CodeShowcase';
import RelatedDocs from '@site/src/components/docs/RelatedDocs';
import WasThisHelpful from '@site/src/components/docs/WasThisHelpful';
import LastUpdated from '@site/src/components/docs/LastUpdated';
import ReadingTime from '@site/src/components/docs/ReadingTime';
import GradientText from '@site/src/components/ui/GradientText';
import GradientButton from '@site/src/components/ui/GradientButton';

<DocSubtitle>
Internal functions and storage for diamond proxy
</DocSubtitle>

<Callout type="info" title="Key Features">
- Provides internal functions for facet management within a diamond.
- Supports the diamond storage pattern (EIP-8042) for shared state.
- `addFacets` is intended for initial diamond deployment only.
- `diamondFallback` enables dynamic function dispatch to registered facets.
</Callout>

<Callout type="info" title="Module Usage">
This module provides internal functions for use in your custom facets. Import it to access shared logic and storage.
</Callout>

## Overview

This module provides internal functions for managing diamond facets and their associated function selectors. It facilitates the diamond storage pattern, allowing all facets to access and modify shared storage. Changes to the diamond's facet registry are immediately visible to all facets interacting with the diamond.

---

## Storage

### DiamondStorage

storage-location: erc8042:erc8109.diamond

<ExpandableCode language="solidity" maxLines={15} title="Definition">
{`struct DiamondStorage {
    mapping(bytes4 functionSelector => FacetAndPosition) facetAndPosition;
    /**
    * \`selectors\` contains all function selectors that can be called in the diamond.
    */
    bytes4[] selectors;
}`}
</ExpandableCode>

---
### FacetAndPosition

<ExpandableCode language="solidity" maxLines={15} title="Definition">
{`struct FacetAndPosition {
    address facet;
    uint32 position;
}`}
</ExpandableCode>

---
### FacetFunctions

<ExpandableCode language="solidity" maxLines={15} title="Definition">
{`struct FacetFunctions {
    address facet;
    bytes4[] selectors;
}`}
</ExpandableCode>

### State Variables

<PropertyTable
  properties={[
    {
      name: "DIAMOND_STORAGE_POSITION",
      type: "bytes32",
      description: "Diamond storage slot position for this module (Value: `keccak256(\"erc8109.diamond\")`)"
    }
  ]}
  showRequired={false}
/>

## Functions

### addFacets

Adds facets and their function selectors to the diamond. Only supports adding functions during diamond deployment.

<ExpandableCode language="solidity" maxLines={8}>
{`function addFacets(FacetFunctions[] memory _facets) ;`}
</ExpandableCode>

**Parameters:**

<PropertyTable
  properties={[
    {
      name: "_facets",
      type: "FacetFunctions[]",
      description: ""
    }
  ]}
  showRequired={false}
/>

---
### diamondFallback

Find facet for function that is called and execute the function if a facet is found and return any value.

<ExpandableCode language="solidity" maxLines={8}>
{`function diamondFallback() ;`}
</ExpandableCode>

---
### getStorage

<ExpandableCode language="solidity" maxLines={8}>
{`function getStorage() pure returns (DiamondStorage storage s);`}
</ExpandableCode>

## Events

<AccordionGroup>
  <Accordion title="DiamondFunctionAdded" defaultOpen={false}>
    <div style={{marginBottom: "1rem"}}>
      Emitted when a function is added to a diamond.
    </div>

    <div style={{marginBottom: "1rem"}}>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
{`event DiamondFunctionAdded(bytes4 indexed _selector, address indexed _facet);`}
      </ExpandableCode>
    </div>

    <div style={{marginBottom: "1rem"}}>
      <strong>Parameters:</strong>
      <PropertyTable
        properties={[
          {
            name: "_selector",
            type: "bytes4",
            description: "The function selector being added."
          },
          {
            name: "_facet",
            type: "address",
            description: "The facet address that will handle calls to `_selector`."
          }
        ]}
        showRequired={false}
      />
    </div>
  </Accordion>
</AccordionGroup>

## Errors

<AccordionGroup>
  <Accordion title="CannotAddFunctionToDiamondThatAlreadyExists" defaultOpen={false}>

    <div>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
error CannotAddFunctionToDiamondThatAlreadyExists(bytes4 _selector);
      </ExpandableCode>
    </div>
  </Accordion>
  <Accordion title="FunctionNotFound" defaultOpen={false}>

    <div>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
error FunctionNotFound(bytes4 _selector);
      </ExpandableCode>
    </div>
  </Accordion>
  <Accordion title="NoBytecodeAtAddress" defaultOpen={false}>

    <div>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
error NoBytecodeAtAddress(address _contractAddress);
      </ExpandableCode>
    </div>
  </Accordion>
</AccordionGroup>

<!-- Usage Example section commented out for now -->
<!--
## Usage Example

<ExpandableCode language="solidity" maxLines={20} title="Example Implementation">
{`pragma solidity >=0.8.30;
import @compose/diamond/DiamondMod;

contract MyFacet {
    // Assume DiamondMod is deployed at address diamondModAddress
    DiamondMod internal diamondMod;

    constructor(address diamondModAddress) {
        diamondMod = DiamondMod(diamondModAddress);
    }

    /**
     * @notice Example of calling addFacets within a diamond deployment context.
     * This function should typically be called only during initial diamond deployment.
     */
    function initializeDiamond(address[] memory _facets, bytes4[] memory _selectors) external {
        // In a real deployment, this would be part of a larger initialization process.
        // For demonstration, we assume _selectors are correctly mapped to _facets.
        // The actual implementation of addFacets would handle the mapping.
        // This example call is illustrative and may require adaptation based on the full deployment script.
        // diamondMod.addFacets(_facets, _selectors);
    }

    /**
     * @notice Example of calling diamondFallback to find and execute a function.
     */
    function delegateCallFunction(bytes memory _calldata) external returns (bytes memory) {
        // diamondMod.diamondFallback(_calldata)
        return ""; // Placeholder return
    }

    /**
     * @notice Example of calling getStorage.
     */
    function viewDiamondStorage() external pure returns (bytes32) {
        return diamondMod.getStorage();
    }
}`}
</ExpandableCode>
-->

## Best Practices

<Callout type="tip" title="Best Practice">
- Call `addFacets` only during the initial deployment of the diamond to avoid collisions.
- Use `diamondFallback` to delegate calls to the appropriate facet for unhandled selectors.
- Verify the `DIAMOND_STORAGE_POSITION` value is correctly set and used by all facets.
</Callout>

## Integration Notes

<Callout type="success" title="Shared Storage">
This module utilizes the diamond storage pattern by referencing `DIAMOND_STORAGE_POSITION` which is set to `keccak256("erc8109.diamond")`. The `DiamondStorage` struct, though empty in definition, represents the shared state managed by the diamond. All functions, particularly `addFacets` and `diamondFallback`, interact with this shared storage to maintain the diamond's facet registry. Changes made via `addFacets` are immediately reflected and accessible by all facets through the diamond proxy.
</Callout>

<div style={{marginTop: "3rem", paddingTop: "2rem", borderTop: "1px solid var(--ifm-color-emphasis-200)"}}>
  <WasThisHelpful pageId="DiamondMod" />
</div>

<LastUpdated date="2025-12-30T18:43:13.729Z" />
