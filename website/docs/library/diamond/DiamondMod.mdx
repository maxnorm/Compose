---
sidebar_position: 1
title: "DiamondMod"
description: "Manage diamond facets and proxy logic"
gitSource: "https://github.com/Perfect-Abstractions/Compose/tree/main/src/diamond/DiamondMod.sol"
---

import DocSubtitle  from '@site/src/components/docs/DocSubtitle';
import Badge from '@site/src/components/ui/Badge';
import Callout from '@site/src/components/ui/Callout';
import CalloutBox from '@site/src/components/ui/CalloutBox';
import Accordion, { AccordionGroup } from '@site/src/components/ui/Accordion';
import PropertyTable from '@site/src/components/api/PropertyTable';
import ExpandableCode from '@site/src/components/code/ExpandableCode';
import CodeShowcase from '@site/src/components/code/CodeShowcase';
import RelatedDocs from '@site/src/components/docs/RelatedDocs';
import WasThisHelpful from '@site/src/components/docs/WasThisHelpful';
import LastUpdated from '@site/src/components/docs/LastUpdated';
import ReadingTime from '@site/src/components/docs/ReadingTime';
import GradientText from '@site/src/components/ui/GradientText';
import GradientButton from '@site/src/components/ui/GradientButton';

<DocSubtitle>
Manage diamond facets and proxy logic
</DocSubtitle>

<Callout type="info" title="Key Features">
- Internal functions for facet management and proxy dispatch.
- Utilizes diamond storage pattern (EIP-8042).
- Supports adding facets during initial diamond deployment.
- Provides a fallback mechanism for function execution within the diamond.
</Callout>

<Callout type="info" title="Module Usage">
This module provides internal functions for use in your custom facets. Import it to access shared logic and storage.
</Callout>

## Overview

This module provides internal functions to manage diamond facets and proxy dispatch. Facets can import this module to add new facets during diamond deployment or to find and execute functions through the diamond proxy. It leverages the diamond storage pattern for centralized management.

---

## Storage

### FacetCutAction

Add=0, Replace=1, Remove=2

---
### DiamondStorage

storage-location: erc8042:compose.diamond

<ExpandableCode language="solidity" maxLines={15} title="Definition">
{`struct DiamondStorage {
    mapping(bytes4 functionSelector => FacetAndPosition) facetAndPosition;
    /**
    * \`selectors\` contains all function selectors that can be called in the diamond.
    */
    bytes4[] selectors;
}`}
</ExpandableCode>

---
### FacetAndPosition

<ExpandableCode language="solidity" maxLines={15} title="Definition">
{`struct FacetAndPosition {
    address facet;
    uint32 position;
}`}
</ExpandableCode>

---
### FacetCut

<ExpandableCode language="solidity" maxLines={15} title="Definition">
{`struct FacetCut {
    address facetAddress;
    FacetCutAction action;
    bytes4[] functionSelectors;
}`}
</ExpandableCode>

### State Variables

<PropertyTable
  properties={[
    {
      name: "DIAMOND_STORAGE_POSITION",
      type: "bytes32",
      description: "Diamond storage slot position for this module (Value: `keccak256(\"compose.diamond\")`)"
    }
  ]}
  showRequired={false}
/>

## Functions

### addFacets

Adds facets and their function selectors to the diamond. Only supports adding functions during diamond deployment.

<ExpandableCode language="solidity" maxLines={8}>
{`function addFacets(FacetCut[] memory _facets) ;`}
</ExpandableCode>

**Parameters:**

<PropertyTable
  properties={[
    {
      name: "_facets",
      type: "FacetCut[]",
      description: ""
    }
  ]}
  showRequired={false}
/>

---
### diamondFallback

Find facet for function that is called and execute the function if a facet is found and return any value.

<ExpandableCode language="solidity" maxLines={8}>
{`function diamondFallback() ;`}
</ExpandableCode>

---
### getStorage

<ExpandableCode language="solidity" maxLines={8}>
{`function getStorage() pure returns (DiamondStorage storage s);`}
</ExpandableCode>

## Events

<AccordionGroup>
  <Accordion title="DiamondCut" defaultOpen={false}>

    <div style={{marginBottom: "1rem"}}>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
{`event DiamondCut(FacetCut[] _diamondCut, address _init, bytes _calldata);`}
      </ExpandableCode>
    </div>

  </Accordion>
</AccordionGroup>

## Errors

<AccordionGroup>
  <Accordion title="CannotAddFunctionToDiamondThatAlreadyExists" defaultOpen={false}>

    <div>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
error CannotAddFunctionToDiamondThatAlreadyExists(bytes4 _selector);
      </ExpandableCode>
    </div>
  </Accordion>
  <Accordion title="FunctionNotFound" defaultOpen={false}>

    <div>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
error FunctionNotFound(bytes4 _selector);
      </ExpandableCode>
    </div>
  </Accordion>
  <Accordion title="InvalidActionWhenDeployingDiamond" defaultOpen={false}>

    <div>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
error InvalidActionWhenDeployingDiamond(address facetAddress, FacetCutAction action, bytes4[] functionSelectors);
      </ExpandableCode>
    </div>
  </Accordion>
  <Accordion title="NoBytecodeAtAddress" defaultOpen={false}>

    <div>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
error NoBytecodeAtAddress(address _contractAddress, string _message);
      </ExpandableCode>
    </div>
  </Accordion>
</AccordionGroup>

<!-- Usage Example section commented out for now -->
<!--
## Usage Example

<ExpandableCode language="solidity" maxLines={20} title="Example Implementation">
{`pragma solidity >=0.8.30;
import @compose/diamond/DiamondMod;

contract MyFacet {
    DiamondMod internal diamondMod;

    constructor(address diamondAddress) {
        diamondMod = DiamondMod(diamondAddress);
    }

    /**
     * @notice Example of adding facets during diamond deployment.
     * @dev This function should only be called during the initial diamond deployment.
     */
    function addMyFacets() external {
        // Assuming DiamondCutMod is available and facet addresses/selectors are defined
        // This is a conceptual example, actual calls require DiamondCutMod context
        // diamondMod.addFacets(...);
    }

    /**
     * @notice Example of calling a function through the diamond proxy.
     * @dev This demonstrates how to find and execute a function selector.
     */
    function callDiamondFunction(bytes4 selector, bytes memory data) external returns (bytes memory) {
        // This is a conceptual example of how diamondFallback would be used internally
        // Direct calls to diamondFallback are not typical from facets.
        // Instead, the diamond proxy itself calls diamondFallback.
        // return diamondMod.diamondFallback(selector, data);
        revert(); // Placeholder as direct calls are not intended
    }

    /**
     * @notice Retrieves the diamond storage information.
     * @return The storage struct.
     */
    function getDiamondStorage() external pure returns (DiamondStorage memory) {
        // This function is a placeholder, as getStorage is pure and doesn't return the struct directly.
        // The actual storage is accessed via its slot.
        return diamondMod.getStorage();
    }
}`}
</ExpandableCode>
-->

## Best Practices

<Callout type="tip" title="Best Practice">
- Use `addFacets` only during initial diamond deployment.
- Inline access control checks before calling internal functions.
- Handle potential `FunctionNotFound` errors when dispatching calls.
</Callout>

## Integration Notes

<Callout type="success" title="Shared Storage">
This module interacts with diamond storage at the `DIAMOND_STORAGE_POSITION` slot, which is defined by `keccak256(\"compose.diamond\")`. It manages the `DiamondStorage` struct, which holds facet cut data. Any modifications made through this module are immediately reflected across all facets interacting with the same diamond storage.
</Callout>

<div style={{marginTop: "3rem", paddingTop: "2rem", borderTop: "1px solid var(--ifm-color-emphasis-200)"}}>
  <RelatedDocs
    items={[
      {
        title: "DiamondCutMod",
        href: "/docs/library/diamond/DiamondCutMod",
        description: "Related module in diamond",
        icon: "ðŸ“¦"
      }
    ]}
  />
</div>

<div style={{marginTop: "3rem", paddingTop: "2rem", borderTop: "1px solid var(--ifm-color-emphasis-200)"}}>
  <WasThisHelpful pageId="DiamondMod" />
</div>

<LastUpdated date="2025-12-30T17:42:32.586Z" />
