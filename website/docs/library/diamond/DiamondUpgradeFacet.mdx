---
sidebar_position: 510
title: "DiamondUpgradeFacet"
description: "Manages diamond upgrades and function registrations"
gitSource: "https://github.com/Perfect-Abstractions/Compose/tree/main/src/diamond/DiamondUpgradeFacet.sol"
---

import DocSubtitle  from '@site/src/components/docs/DocSubtitle';
import Badge from '@site/src/components/ui/Badge';
import Callout from '@site/src/components/ui/Callout';
import CalloutBox from '@site/src/components/ui/CalloutBox';
import Accordion, { AccordionGroup } from '@site/src/components/ui/Accordion';
import PropertyTable from '@site/src/components/api/PropertyTable';
import ExpandableCode from '@site/src/components/code/ExpandableCode';
import CodeShowcase from '@site/src/components/code/CodeShowcase';
import RelatedDocs from '@site/src/components/docs/RelatedDocs';
import WasThisHelpful from '@site/src/components/docs/WasThisHelpful';
import LastUpdated from '@site/src/components/docs/LastUpdated';
import ReadingTime from '@site/src/components/docs/ReadingTime';
import GradientText from '@site/src/components/ui/GradientText';
import GradientButton from '@site/src/components/ui/GradientButton';

<DocSubtitle>
Manages diamond upgrades and function registrations
</DocSubtitle>

<Callout type="info" title="Key Features">
- Manages diamond upgrades by adding, replacing, and removing functions.
- Supports delegate calls for executing arbitrary logic within the diamond context.
- Emits events for all significant upgrade operations.
- Integrates with Compose's storage pattern for owner management.
</Callout>

## Overview

This facet provides core functionality for upgrading and managing facets within a Compose diamond. It allows for adding, replacing, and removing functions, as well as executing arbitrary delegate calls and setting diamond metadata. Developers use this facet to control the diamond's upgradeability and function registry.

---

## Storage

### OwnerStorage

<ExpandableCode language="solidity" maxLines={15} title="Definition">
{`struct OwnerStorage {
    address owner;
}`}
</ExpandableCode>

---
### FacetAndPosition

<ExpandableCode language="solidity" maxLines={15} title="Definition">
{`struct FacetAndPosition {
    address facet;
    uint32 position;
}`}
</ExpandableCode>

---
### DiamondStorage

<ExpandableCode language="solidity" maxLines={15} title="Definition">
{`struct DiamondStorage {
    mapping(bytes4 functionSelector => FacetAndPosition) facetAndPosition;
    /**
    * Array of all function selectors that can be called in the diamond
    */
    bytes4[] selectors;
}`}
</ExpandableCode>

---
### FacetFunctions

<ExpandableCode language="solidity" maxLines={15} title="Definition">
{`struct FacetFunctions {
    address facet;
    bytes4[] selectors;
}`}
</ExpandableCode>

### State Variables

<PropertyTable
  properties={[
    {
      name: "OWNER_STORAGE_POSITION",
      type: "bytes32",
      description: "Diamond storage slot position for this module (Value: `keccak256(\"compose.owner\")`)"
    },
    {
      name: "DIAMOND_STORAGE_POSITION",
      type: "bytes32",
      description: "Diamond storage slot position for this module (Value: `keccak256(\"erc8109.diamond\")`)"
    }
  ]}
  showRequired={false}
/>

## Functions

### upgradeDiamond

---
### Function Changes:

---
### DelegateCall:

---
### Metadata:

If _tag is non-zero or if _metadata.length &gt; 0 then the `DiamondMetadata` event is emitted.

<ExpandableCode language="solidity" maxLines={8}>
{`function upgradeDiamond(
    FacetFunctions[] calldata _addFunctions,
    FacetFunctions[] calldata _replaceFunctions,
    bytes4[] calldata _removeFunctions,
    address _delegate,
    bytes calldata _functionCall,
    bytes32 _tag,
    bytes calldata _metadata
) external;`}
</ExpandableCode>

**Parameters:**

<PropertyTable
  properties={[
    {
      name: "_addFunctions",
      type: "FacetFunctions[]",
      description: "Selectors to add, grouped by facet."
    },
    {
      name: "_replaceFunctions",
      type: "FacetFunctions[]",
      description: "Selectors to replace, grouped by facet."
    },
    {
      name: "_removeFunctions",
      type: "bytes4[]",
      description: "Selectors to remove."
    },
    {
      name: "_delegate",
      type: "address",
      description: "Optional contract to delegatecall (zero address to skip)."
    },
    {
      name: "_functionCall",
      type: "bytes",
      description: "Optional calldata to execute on `_delegate`."
    },
    {
      name: "_tag",
      type: "bytes32",
      description: "Optional arbitrary metadata, such as release version."
    },
    {
      name: "_metadata",
      type: "bytes",
      description: "Optional arbitrary data."
    }
  ]}
  showRequired={false}
/>

## Events

<AccordionGroup>
  <Accordion title="DiamondFunctionAdded" defaultOpen={false}>
    <div style={{marginBottom: "1rem"}}>
      Emitted when a function is added to a diamond.
    </div>

    <div style={{marginBottom: "1rem"}}>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
{`event DiamondFunctionAdded(bytes4 indexed _selector, address indexed _facet);`}
      </ExpandableCode>
    </div>

    <div style={{marginBottom: "1rem"}}>
      <strong>Parameters:</strong>
      <PropertyTable
        properties={[
          {
            name: "_selector",
            type: "bytes4",
            description: "The function selector being added."
          },
          {
            name: "_facet",
            type: "address",
            description: "The facet address that will handle calls to `_selector`."
          }
        ]}
        showRequired={false}
      />
    </div>
  </Accordion>
  <Accordion title="DiamondFunctionReplaced" defaultOpen={false}>
    <div style={{marginBottom: "1rem"}}>
      Emitted when changing the facet that will handle calls to a function.
    </div>

    <div style={{marginBottom: "1rem"}}>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
{`event DiamondFunctionReplaced(bytes4 indexed _selector, address indexed _oldFacet, address indexed _newFacet);`}
      </ExpandableCode>
    </div>

    <div style={{marginBottom: "1rem"}}>
      <strong>Parameters:</strong>
      <PropertyTable
        properties={[
          {
            name: "_selector",
            type: "bytes4",
            description: "The function selector being affected."
          },
          {
            name: "_oldFacet",
            type: "address",
            description: "The facet address previously responsible for `_selector`."
          },
          {
            name: "_newFacet",
            type: "address",
            description: "The facet address that will now handle calls to `_selector`."
          }
        ]}
        showRequired={false}
      />
    </div>
  </Accordion>
  <Accordion title="DiamondFunctionRemoved" defaultOpen={false}>
    <div style={{marginBottom: "1rem"}}>
      Emitted when a function is removed from a diamond.
    </div>

    <div style={{marginBottom: "1rem"}}>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
{`event DiamondFunctionRemoved(bytes4 indexed _selector, address indexed _oldFacet);`}
      </ExpandableCode>
    </div>

    <div style={{marginBottom: "1rem"}}>
      <strong>Parameters:</strong>
      <PropertyTable
        properties={[
          {
            name: "_selector",
            type: "bytes4",
            description: "The function selector being removed."
          },
          {
            name: "_oldFacet",
            type: "address",
            description: "The facet address that previously handled `_selector`."
          }
        ]}
        showRequired={false}
      />
    </div>
  </Accordion>
  <Accordion title="DiamondDelegateCall" defaultOpen={false}>
    <div style={{marginBottom: "1rem"}}>
      Emitted when a diamond's constructor function or function from a facet makes a `delegatecall`.
    </div>

    <div style={{marginBottom: "1rem"}}>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
{`event DiamondDelegateCall(address indexed _delegate, bytes _functionCall);`}
      </ExpandableCode>
    </div>

    <div style={{marginBottom: "1rem"}}>
      <strong>Parameters:</strong>
      <PropertyTable
        properties={[
          {
            name: "_delegate",
            type: "address",
            description: "The contract that was delegatecalled."
          },
          {
            name: "_functionCall",
            type: "bytes",
            description: "The function call, including function selector and any arguments."
          }
        ]}
        showRequired={false}
      />
    </div>
  </Accordion>
  <Accordion title="DiamondMetadata" defaultOpen={false}>
    <div style={{marginBottom: "1rem"}}>
      Emitted to record information about a diamond. This event records any arbitrary metadata. The format of `_tag` and `_data` are not specified by the standard.
    </div>

    <div style={{marginBottom: "1rem"}}>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
{`event DiamondMetadata(bytes32 indexed _tag, bytes _data);`}
      </ExpandableCode>
    </div>

    <div style={{marginBottom: "1rem"}}>
      <strong>Parameters:</strong>
      <PropertyTable
        properties={[
          {
            name: "_tag",
            type: "bytes32",
            description: "Arbitrary metadata, such as a release version."
          },
          {
            name: "_data",
            type: "bytes",
            description: "Arbitrary metadata."
          }
        ]}
        showRequired={false}
      />
    </div>
  </Accordion>
</AccordionGroup>

## Errors

<AccordionGroup>
  <Accordion title="OwnerUnauthorizedAccount" defaultOpen={false}>

    <div>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
error OwnerUnauthorizedAccount();
      </ExpandableCode>
    </div>
  </Accordion>
  <Accordion title="NoSelectorsProvidedForFacet" defaultOpen={false}>

    <div>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
error NoSelectorsProvidedForFacet(address _facet);
      </ExpandableCode>
    </div>
  </Accordion>
  <Accordion title="NoBytecodeAtAddress" defaultOpen={false}>

    <div>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
error NoBytecodeAtAddress(address _contractAddress);
      </ExpandableCode>
    </div>
  </Accordion>
  <Accordion title="CannotAddFunctionToDiamondThatAlreadyExists" defaultOpen={false}>

    <div>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
error CannotAddFunctionToDiamondThatAlreadyExists(bytes4 _selector);
      </ExpandableCode>
    </div>
  </Accordion>
  <Accordion title="CannotReplaceFunctionThatDoesNotExist" defaultOpen={false}>

    <div>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
error CannotReplaceFunctionThatDoesNotExist(bytes4 _selector);
      </ExpandableCode>
    </div>
  </Accordion>
  <Accordion title="CannotRemoveFunctionThatDoesNotExist" defaultOpen={false}>

    <div>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
error CannotRemoveFunctionThatDoesNotExist(bytes4 _selector);
      </ExpandableCode>
    </div>
  </Accordion>
  <Accordion title="CannotReplaceFunctionWithTheSameFacet" defaultOpen={false}>

    <div>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
error CannotReplaceFunctionWithTheSameFacet(bytes4 _selector);
      </ExpandableCode>
    </div>
  </Accordion>
  <Accordion title="DelegateCallReverted" defaultOpen={false}>

    <div>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
error DelegateCallReverted(address _delegate, bytes _functionCall);
      </ExpandableCode>
    </div>
  </Accordion>
  <Accordion title="CannotReplaceImmutableFunction" defaultOpen={false}>

    <div>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
error CannotReplaceImmutableFunction(bytes4 _selector);
      </ExpandableCode>
    </div>
  </Accordion>
  <Accordion title="CannotRemoveImmutableFunction" defaultOpen={false}>

    <div>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
error CannotRemoveImmutableFunction(bytes4 _selector);
      </ExpandableCode>
    </div>
  </Accordion>
</AccordionGroup>

<!-- Usage Example section commented out for now -->
<!--
## Usage Example

<ExpandableCode language="solidity" maxLines={20} title="Example Implementation">
{`pragma solidity >=0.8.30;

import {IDiamond} from "@compose/diamond/IDiamond.sol";
import {DiamondUpgradeFacet} from "@compose/diamond/DiamondUpgradeFacet.sol";

contract Deployer {
    address immutable diamondAddress;

    constructor(address _diamondAddress) {
        diamondAddress = _diamondAddress;
    }

    function upgradeDiamondWithNewFacet(address _newFacetAddress, bytes[] memory _functionSelectors) public {
        IDiamond diamond = IDiamond(diamondAddress);
        // Assuming DiamondUpgradeFacet is already added to the diamond
        // and the caller has the necessary permissions (e.g., owner role)
        diamond.upgradeDiamond(
            _newFacetAddress, // Address of the new facet contract
            _functionSelectors, // List of function selectors to add from the new facet
            new bytes[](0), // No selectors to replace
            new bytes4[](0) // No selectors to remove
        );
    }

    function registerMetadata(bytes32 _tag, bytes memory _metadata) public {
        IDiamond diamond = IDiamond(diamondAddress);
        diamond.setMetadata(_tag, _metadata);
    }
}`}
</ExpandableCode>
-->

## Best Practices

<Callout type="tip" title="Best Practice">
- Ensure the caller has the necessary permissions to execute upgrade functions.
- Verify function selectors and facet addresses before calling upgrade functions.
- Use the `DiamondMetadata` event to track changes to diamond metadata.
</Callout>

## Security Considerations

<Callout type="warning" title="Security">
All functions that modify the diamond's state (e.g., `upgradeDiamond`, `addFunctions`, `replaceFunctions`, `removeFunctions`, `setMetadata`) must be protected by appropriate access control mechanisms, typically managed by an owner role. The `delegateCall` function should be used with extreme caution due to the potential for reentrancy and state manipulation. Input validation on function selectors and facet addresses is critical.
</Callout>

<div style={{marginTop: "3rem", paddingTop: "2rem", borderTop: "1px solid var(--ifm-color-emphasis-200)"}}>
  <RelatedDocs
    items={[
      {
        title: "DiamondUpgradeMod",
        href: "/docs/library/diamond/DiamondUpgradeMod",
        description: "Module used by DiamondUpgradeFacet",
        icon: "ðŸ“¦"
      },
      {
        title: "DiamondInspectFacet",
        href: "/docs/library/diamond/DiamondInspectFacet",
        description: "Related facet in diamond",
        icon: "ðŸ’Ž"
      },
      {
        title: "ExampleDiamond",
        href: "/docs/library/diamond/example/ExampleDiamond",
        description: "Related facet in diamond",
        icon: "ðŸ’Ž"
      }
    ]}
  />
</div>

<div style={{marginTop: "3rem", paddingTop: "2rem", borderTop: "1px solid var(--ifm-color-emphasis-200)"}}>
  <WasThisHelpful pageId="DiamondUpgradeFacet" />
</div>

<LastUpdated date="2025-12-30T20:09:42.402Z" />
