---
sidebar_position: 500
title: "DiamondUpgradeMod"
description: "Manage diamond facets and delegate calls"
gitSource: "https://github.com/Perfect-Abstractions/Compose/tree/main/src/diamond/DiamondUpgradeMod.sol"
---

import DocSubtitle  from '@site/src/components/docs/DocSubtitle';
import Badge from '@site/src/components/ui/Badge';
import Callout from '@site/src/components/ui/Callout';
import CalloutBox from '@site/src/components/ui/CalloutBox';
import Accordion, { AccordionGroup } from '@site/src/components/ui/Accordion';
import PropertyTable from '@site/src/components/api/PropertyTable';
import ExpandableCode from '@site/src/components/code/ExpandableCode';
import CodeShowcase from '@site/src/components/code/CodeShowcase';
import RelatedDocs from '@site/src/components/docs/RelatedDocs';
import WasThisHelpful from '@site/src/components/docs/WasThisHelpful';
import LastUpdated from '@site/src/components/docs/LastUpdated';
import ReadingTime from '@site/src/components/docs/ReadingTime';
import GradientText from '@site/src/components/ui/GradientText';
import GradientButton from '@site/src/components/ui/GradientButton';

<DocSubtitle>
Manage diamond facets and delegate calls
</DocSubtitle>

<Callout type="info" title="Key Features">
- Manages facet additions, replacements, and removals on a diamond.
- Supports delegate calls for state manipulation during upgrades.
- Emits detailed events for upgrade actions (add, replace, remove, delegate call, metadata).
- Includes specific errors to prevent invalid state transitions.
</Callout>

<Callout type="info" title="Module Usage">
This module provides internal functions for use in your custom facets. Import it to access shared logic and storage.
</Callout>

## Overview

This module provides functions to add, replace, and remove facets on a diamond. It facilitates diamond upgrades by composing facets and managing their selectors. Internal delegate calls can also be executed for state modifications or initialization during upgrades. Changes made through this module are applied directly to the diamond's facet registry, impacting all facets interacting with the diamond.

---

## Storage

### DiamondStorage

storage-location: erc8042:erc8109.diamond

<ExpandableCode language="solidity" maxLines={15} title="Definition">
{`struct DiamondStorage {
    mapping(bytes4 functionSelector => FacetAndPosition) facetAndPosition;
    /**
    * Array of all function selectors that can be called in the diamond
    */
    bytes4[] selectors;
}`}
</ExpandableCode>

---
### FacetAndPosition

Data stored for each function selector Facet address of function selector Position of selector in the 'bytes4[] selectors' array

<ExpandableCode language="solidity" maxLines={15} title="Definition">
{`struct FacetAndPosition {
    address facet;
    uint32 position;
}`}
</ExpandableCode>

---
### FacetFunctions

<ExpandableCode language="solidity" maxLines={15} title="Definition">
{`struct FacetFunctions {
    address facet;
    bytes4[] selectors;
}`}
</ExpandableCode>

### State Variables

<PropertyTable
  properties={[
    {
      name: "DIAMOND_STORAGE_POSITION",
      type: "bytes32",
      description: "Diamond storage slot position for this module (Value: `keccak256(\"erc8109.diamond\")`)"
    }
  ]}
  showRequired={false}
/>

## Functions

### addFunctions

<ExpandableCode language="solidity" maxLines={8}>
{`function addFunctions(address _facet, bytes4[] calldata _functionSelectors) ;`}
</ExpandableCode>

**Parameters:**

<PropertyTable
  properties={[
    {
      name: "_facet",
      type: "address",
      description: ""
    },
    {
      name: "_functionSelectors",
      type: "bytes4[]",
      description: ""
    }
  ]}
  showRequired={false}
/>

---
### getDiamondStorage

<ExpandableCode language="solidity" maxLines={8}>
{`function getDiamondStorage() pure returns (DiamondStorage storage s);`}
</ExpandableCode>

---
### removeFunctions

<ExpandableCode language="solidity" maxLines={8}>
{`function removeFunctions(bytes4[] calldata _functionSelectors) ;`}
</ExpandableCode>

**Parameters:**

<PropertyTable
  properties={[
    {
      name: "_functionSelectors",
      type: "bytes4[]",
      description: ""
    }
  ]}
  showRequired={false}
/>

---
### replaceFunctions

<ExpandableCode language="solidity" maxLines={8}>
{`function replaceFunctions(address _facet, bytes4[] calldata _functionSelectors) ;`}
</ExpandableCode>

**Parameters:**

<PropertyTable
  properties={[
    {
      name: "_facet",
      type: "address",
      description: ""
    },
    {
      name: "_functionSelectors",
      type: "bytes4[]",
      description: ""
    }
  ]}
  showRequired={false}
/>

---
### upgradeDiamond

Upgrade the diamond by adding, replacing, or removing functions. - `_addFunctions` maps new selectors to their facet implementations. - `_replaceFunctions` updates existing selectors to new facet addresses. - `_removeFunctions` removes selectors from the diamond. Functions added first, then replaced, then removed. These events are emitted to record changes to functions: - `DiamondFunctionAdded` - `DiamondFunctionReplaced` - `DiamondFunctionRemoved` If `_delegate` is non-zero, the diamond performs a `delegatecall` to `_delegate` using `_functionCall`. The `DiamondDelegateCall` event is emitted. The `delegatecall` is done to alter a diamond's state or to initialize, modify, or remove state after an upgrade. However, if `_delegate` is zero, no `delegatecall` is made and no `DiamondDelegateCall` event is emitted. If _tag is non-zero or if _metadata.length &gt; 0 then the `DiamondMetadata` event is emitted.

<ExpandableCode language="solidity" maxLines={8}>
{`function upgradeDiamond(
FacetFunctions[] calldata _addFunctions,
FacetFunctions[] calldata _replaceFunctions,
bytes4[] calldata _removeFunctions,
address _delegate,
bytes calldata _functionCall,
bytes32 _tag,
bytes calldata _metadata
) ;`}
</ExpandableCode>

**Parameters:**

<PropertyTable
  properties={[
    {
      name: "_addFunctions",
      type: "FacetFunctions[]",
      description: "Selectors to add, grouped by facet."
    },
    {
      name: "_replaceFunctions",
      type: "FacetFunctions[]",
      description: "Selectors to replace, grouped by facet."
    },
    {
      name: "_removeFunctions",
      type: "bytes4[]",
      description: "Selectors to remove."
    },
    {
      name: "_delegate",
      type: "address",
      description: "Optional contract to delegatecall (zero address to skip)."
    },
    {
      name: "_functionCall",
      type: "bytes",
      description: "Optional calldata to execute on `_delegate`."
    },
    {
      name: "_tag",
      type: "bytes32",
      description: "Optional arbitrary metadata, such as release version."
    },
    {
      name: "_metadata",
      type: "bytes",
      description: "Optional arbitrary data."
    }
  ]}
  showRequired={false}
/>

## Events

<AccordionGroup>
  <Accordion title="DiamondDelegateCall" defaultOpen={false}>
    <div style={{marginBottom: "1rem"}}>
      Emitted when a diamond's constructor function or function from a facet makes a `delegatecall`.
    </div>

    <div style={{marginBottom: "1rem"}}>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
{`event DiamondDelegateCall(address indexed _delegate, bytes _functionCall);`}
      </ExpandableCode>
    </div>

    <div style={{marginBottom: "1rem"}}>
      <strong>Parameters:</strong>
      <PropertyTable
        properties={[
          {
            name: "_delegate",
            type: "address",
            description: "The contract that was delegatecalled."
          },
          {
            name: "_functionCall",
            type: "bytes",
            description: "The function call, including function selector and any arguments."
          }
        ]}
        showRequired={false}
      />
    </div>
  </Accordion>
  <Accordion title="DiamondFunctionAdded" defaultOpen={false}>
    <div style={{marginBottom: "1rem"}}>
      Emitted when a function is added to a diamond.
    </div>

    <div style={{marginBottom: "1rem"}}>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
{`event DiamondFunctionAdded(bytes4 indexed _selector, address indexed _facet);`}
      </ExpandableCode>
    </div>

    <div style={{marginBottom: "1rem"}}>
      <strong>Parameters:</strong>
      <PropertyTable
        properties={[
          {
            name: "_selector",
            type: "bytes4",
            description: "The function selector being added."
          },
          {
            name: "_facet",
            type: "address",
            description: "The facet address that will handle calls to `_selector`."
          }
        ]}
        showRequired={false}
      />
    </div>
  </Accordion>
  <Accordion title="DiamondFunctionRemoved" defaultOpen={false}>
    <div style={{marginBottom: "1rem"}}>
      Emitted when a function is removed from a diamond.
    </div>

    <div style={{marginBottom: "1rem"}}>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
{`event DiamondFunctionRemoved(bytes4 indexed _selector, address indexed _oldFacet);`}
      </ExpandableCode>
    </div>

    <div style={{marginBottom: "1rem"}}>
      <strong>Parameters:</strong>
      <PropertyTable
        properties={[
          {
            name: "_selector",
            type: "bytes4",
            description: "The function selector being removed."
          },
          {
            name: "_oldFacet",
            type: "address",
            description: "The facet address that previously handled `_selector`."
          }
        ]}
        showRequired={false}
      />
    </div>
  </Accordion>
  <Accordion title="DiamondFunctionReplaced" defaultOpen={false}>
    <div style={{marginBottom: "1rem"}}>
      Emitted when changing the facet that will handle calls to a function.
    </div>

    <div style={{marginBottom: "1rem"}}>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
{`event DiamondFunctionReplaced(bytes4 indexed _selector, address indexed _oldFacet, address indexed _newFacet);`}
      </ExpandableCode>
    </div>

    <div style={{marginBottom: "1rem"}}>
      <strong>Parameters:</strong>
      <PropertyTable
        properties={[
          {
            name: "_selector",
            type: "bytes4",
            description: "The function selector being affected."
          },
          {
            name: "_oldFacet",
            type: "address",
            description: "The facet address previously responsible for `_selector`."
          },
          {
            name: "_newFacet",
            type: "address",
            description: "The facet address that will now handle calls to `_selector`."
          }
        ]}
        showRequired={false}
      />
    </div>
  </Accordion>
  <Accordion title="DiamondMetadata" defaultOpen={false}>
    <div style={{marginBottom: "1rem"}}>
      Emitted to record information about a diamond. This event records any arbitrary metadata. The format of `_tag` and `_data` are not specified by the standard.
    </div>

    <div style={{marginBottom: "1rem"}}>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
{`event DiamondMetadata(bytes32 indexed _tag, bytes _data);`}
      </ExpandableCode>
    </div>

    <div style={{marginBottom: "1rem"}}>
      <strong>Parameters:</strong>
      <PropertyTable
        properties={[
          {
            name: "_tag",
            type: "bytes32",
            description: "Arbitrary metadata, such as a release version."
          },
          {
            name: "_data",
            type: "bytes",
            description: "Arbitrary metadata."
          }
        ]}
        showRequired={false}
      />
    </div>
  </Accordion>
</AccordionGroup>

## Errors

<AccordionGroup>
  <Accordion title="CannotAddFunctionToDiamondThatAlreadyExists" defaultOpen={false}>

    <div>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
error CannotAddFunctionToDiamondThatAlreadyExists(bytes4 _selector);
      </ExpandableCode>
    </div>
  </Accordion>
  <Accordion title="CannotRemoveFunctionThatDoesNotExist" defaultOpen={false}>

    <div>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
error CannotRemoveFunctionThatDoesNotExist(bytes4 _selector);
      </ExpandableCode>
    </div>
  </Accordion>
  <Accordion title="CannotRemoveImmutableFunction" defaultOpen={false}>

    <div>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
error CannotRemoveImmutableFunction(bytes4 _selector);
      </ExpandableCode>
    </div>
  </Accordion>
  <Accordion title="CannotReplaceFunctionThatDoesNotExist" defaultOpen={false}>

    <div>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
error CannotReplaceFunctionThatDoesNotExist(bytes4 _selector);
      </ExpandableCode>
    </div>
  </Accordion>
  <Accordion title="CannotReplaceFunctionWithTheSameFacet" defaultOpen={false}>

    <div>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
error CannotReplaceFunctionWithTheSameFacet(bytes4 _selector);
      </ExpandableCode>
    </div>
  </Accordion>
  <Accordion title="CannotReplaceImmutableFunction" defaultOpen={false}>

    <div>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
error CannotReplaceImmutableFunction(bytes4 _selector);
      </ExpandableCode>
    </div>
  </Accordion>
  <Accordion title="DelegateCallReverted" defaultOpen={false}>

    <div>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
error DelegateCallReverted(address _delegate, bytes _functionCall);
      </ExpandableCode>
    </div>
  </Accordion>
  <Accordion title="NoBytecodeAtAddress" defaultOpen={false}>

    <div>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
error NoBytecodeAtAddress(address _contractAddress);
      </ExpandableCode>
    </div>
  </Accordion>
  <Accordion title="NoSelectorsProvidedForFacet" defaultOpen={false}>
    <div style={{marginBottom: "1rem"}}>
      The functions below detect and revert with the following errors.
    </div>

    <div>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
error NoSelectorsProvidedForFacet(address _facet);
      </ExpandableCode>
    </div>
  </Accordion>
</AccordionGroup>

<!-- Usage Example section commented out for now -->
<!--
## Usage Example

<ExpandableCode language="solidity" maxLines={20} title="Example Implementation">
{`pragma solidity >=0.8.30;

import {DiamondUpgradeMod} from '@compose/diamond/DiamondUpgradeMod';
import {FacetFunctions} from '@compose/diamond/DiamondUpgradeMod';

contract MyFacet {
    DiamondUpgradeMod internal diamondUpgradeMod;

    constructor(address diamondAddress) {
        diamondUpgradeMod = DiamondUpgradeMod(diamondAddress);
    }

    function upgradeMyFacet() external {
        address newFacetAddress = address(this);
        bytes4[] memory selectorsToRemove = new bytes4[](0);
        FacetFunctions[] memory functionsToAdd = new FacetFunctions[](0);
        FacetFunctions[] memory functionsToReplace = new FacetFunctions[](1);

        functionsToReplace[0] = FacetFunctions({
            facetAddress: newFacetAddress,
            selectors: new bytes4[](0) // Specify selectors if replacing specific ones
        });

        // Example of adding a function (if it doesn't exist)
        // functionsToAdd.push(FacetFunctions({
        //     facetAddress: newFacetAddress,
        //     selectors: new bytes4[](1) // Example: Add selector for a new function
        // }));
        // functionsToAdd[0].selectors[0] = this.myNewFunction.selector;

        // Example of removing a function (if it exists)
        // selectorsToRemove.push(this.oldFunction.selector);

        diamondUpgradeMod.upgradeDiamond(
            functionsToAdd,
            functionsToReplace,
            selectorsToRemove,
            address(0), // No delegate call in this example
            '',
            bytes32(0),
            ''
        );
    }
}`}
</ExpandableCode>
-->

## Best Practices

<Callout type="tip" title="Best Practice">
- Ensure selector uniqueness before adding or replacing facets to avoid collisions.
- Verify that immutable functions are not targeted for removal or replacement.
- Handle errors such as `CannotAddFunctionToDiamondThatAlreadyExists` and `DelegateCallReverted` for robust upgrade processes.
</Callout>

## Integration Notes

<Callout type="success" title="Shared Storage">
This module interacts directly with the diamond's storage, identified by `DIAMOND_STORAGE_POSITION` which maps to `keccak256(\"erc8109.diamond\")`. It utilizes the `DiamondStorage` struct to manage facet mappings. All functions operate internally, modifying the diamond's facet registry. Changes are immediately effective for all facets interacting with the diamond.
</Callout>

<div style={{marginTop: "3rem", paddingTop: "2rem", borderTop: "1px solid var(--ifm-color-emphasis-200)"}}>
  <RelatedDocs
    items={[
      {
        title: "DiamondMod",
        href: "/docs/library/diamond/DiamondMod",
        description: "Related module in diamond",
        icon: "ðŸ“¦"
      }
    ]}
  />
</div>

<div style={{marginTop: "3rem", paddingTop: "2rem", borderTop: "1px solid var(--ifm-color-emphasis-200)"}}>
  <WasThisHelpful pageId="DiamondUpgradeMod" />
</div>

<LastUpdated date="2025-12-30T20:09:37.984Z" />
