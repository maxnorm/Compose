---
sidebar_position: 500
title: "DiamondUpgradeMod"
description: "Upgrade diamond facets and manage function selectors"
gitSource: "https://github.com/Perfect-Abstractions/Compose/tree/main/src/diamond/DiamondUpgradeMod.sol"
---

import DocSubtitle  from '@site/src/components/docs/DocSubtitle';
import Badge from '@site/src/components/ui/Badge';
import Callout from '@site/src/components/ui/Callout';
import CalloutBox from '@site/src/components/ui/CalloutBox';
import Accordion, { AccordionGroup } from '@site/src/components/ui/Accordion';
import PropertyTable from '@site/src/components/api/PropertyTable';
import ExpandableCode from '@site/src/components/code/ExpandableCode';
import CodeShowcase from '@site/src/components/code/CodeShowcase';
import RelatedDocs from '@site/src/components/docs/RelatedDocs';
import WasThisHelpful from '@site/src/components/docs/WasThisHelpful';
import LastUpdated from '@site/src/components/docs/LastUpdated';
import ReadingTime from '@site/src/components/docs/ReadingTime';
import GradientText from '@site/src/components/ui/GradientText';
import GradientButton from '@site/src/components/ui/GradientButton';

<DocSubtitle>
Upgrade diamond facets and manage function selectors
</DocSubtitle>

<Callout type="info" title="Key Features">
- Facet functions are `external` or `internal`, allowing integration into custom facets.
- Supports adding, replacing, and removing function selectors atomically.
- Emits events (`DiamondFunctionAdded`, `DiamondFunctionReplaced`, `DiamondFunctionRemoved`, `DiamondDelegateCall`, `DiamondMetadata`) to log upgrade activities.
- Enables state modification via `delegatecall` during upgrades.
</Callout>

<Callout type="info" title="Module Usage">
This module provides internal functions for use in your custom facets. Import it to access shared logic and storage.
</Callout>

## Overview

This module provides core functionality for upgrading diamond facets and managing function selectors. Facets import this module to add, replace, or remove functions, enabling dynamic updates to a diamond's capabilities. It ensures that changes are atomically applied and uses delegate calls for state modifications during upgrades.

---

## Storage

### DiamondStorage

storage-location: erc8042:erc8109.diamond

<ExpandableCode language="solidity" maxLines={15} title="Definition">
{`struct DiamondStorage {
    mapping(bytes4 functionSelector => FacetAndPosition) facetAndPosition;
    /**
    * Array of all function selectors that can be called in the diamond
    */
    bytes4[] selectors;
}`}
</ExpandableCode>

---
### FacetAndPosition

Data stored for each function selector Facet address of function selector Position of selector in the 'bytes4[] selectors' array

<ExpandableCode language="solidity" maxLines={15} title="Definition">
{`struct FacetAndPosition {
    address facet;
    uint32 position;
}`}
</ExpandableCode>

---
### FacetFunctions

<ExpandableCode language="solidity" maxLines={15} title="Definition">
{`struct FacetFunctions {
    address facet;
    bytes4[] selectors;
}`}
</ExpandableCode>

### State Variables

<PropertyTable
  properties={[
    {
      name: "DIAMOND_STORAGE_POSITION",
      type: "bytes32",
      description: "Diamond storage slot position for this module (Value: `keccak256(\"erc8109.diamond\")`)"
    }
  ]}
  showRequired={false}
/>

## Functions

### addFunctions

<ExpandableCode language="solidity" maxLines={8}>
{`function addFunctions(address _facet, bytes4[] calldata _functionSelectors) ;`}
</ExpandableCode>

**Parameters:**

<PropertyTable
  properties={[
    {
      name: "_facet",
      type: "address",
      description: ""
    },
    {
      name: "_functionSelectors",
      type: "bytes4[]",
      description: ""
    }
  ]}
  showRequired={false}
/>

---
### getDiamondStorage

<ExpandableCode language="solidity" maxLines={8}>
{`function getDiamondStorage() pure returns (DiamondStorage storage s);`}
</ExpandableCode>

---
### removeFunctions

<ExpandableCode language="solidity" maxLines={8}>
{`function removeFunctions(bytes4[] calldata _functionSelectors) ;`}
</ExpandableCode>

**Parameters:**

<PropertyTable
  properties={[
    {
      name: "_functionSelectors",
      type: "bytes4[]",
      description: ""
    }
  ]}
  showRequired={false}
/>

---
### replaceFunctions

<ExpandableCode language="solidity" maxLines={8}>
{`function replaceFunctions(address _facet, bytes4[] calldata _functionSelectors) ;`}
</ExpandableCode>

**Parameters:**

<PropertyTable
  properties={[
    {
      name: "_facet",
      type: "address",
      description: ""
    },
    {
      name: "_functionSelectors",
      type: "bytes4[]",
      description: ""
    }
  ]}
  showRequired={false}
/>

---
### upgradeDiamond

Upgrade the diamond by adding, replacing, or removing functions. - `_addFunctions` maps new selectors to their facet implementations. - `_replaceFunctions` updates existing selectors to new facet addresses. - `_removeFunctions` removes selectors from the diamond. Functions added first, then replaced, then removed. These events are emitted to record changes to functions: - `DiamondFunctionAdded` - `DiamondFunctionReplaced` - `DiamondFunctionRemoved` If `_delegate` is non-zero, the diamond performs a `delegatecall` to `_delegate` using `_functionCall`. The `DiamondDelegateCall` event is emitted. The `delegatecall` is done to alter a diamond's state or to initialize, modify, or remove state after an upgrade. However, if `_delegate` is zero, no `delegatecall` is made and no `DiamondDelegateCall` event is emitted. If _tag is non-zero or if _metadata.length &gt; 0 then the `DiamondMetadata` event is emitted.

<ExpandableCode language="solidity" maxLines={8}>
{`function upgradeDiamond(
FacetFunctions[] calldata _addFunctions,
FacetFunctions[] calldata _replaceFunctions,
bytes4[] calldata _removeFunctions,
address _delegate,
bytes calldata _functionCall,
bytes32 _tag,
bytes calldata _metadata
) ;`}
</ExpandableCode>

**Parameters:**

<PropertyTable
  properties={[
    {
      name: "_addFunctions",
      type: "FacetFunctions[]",
      description: "Selectors to add, grouped by facet."
    },
    {
      name: "_replaceFunctions",
      type: "FacetFunctions[]",
      description: "Selectors to replace, grouped by facet."
    },
    {
      name: "_removeFunctions",
      type: "bytes4[]",
      description: "Selectors to remove."
    },
    {
      name: "_delegate",
      type: "address",
      description: "Optional contract to delegatecall (zero address to skip)."
    },
    {
      name: "_functionCall",
      type: "bytes",
      description: "Optional calldata to execute on `_delegate`."
    },
    {
      name: "_tag",
      type: "bytes32",
      description: "Optional arbitrary metadata, such as release version."
    },
    {
      name: "_metadata",
      type: "bytes",
      description: "Optional arbitrary data."
    }
  ]}
  showRequired={false}
/>

## Events

<AccordionGroup>
  <Accordion title="DiamondDelegateCall" defaultOpen={false}>
    <div style={{marginBottom: "1rem"}}>
      Emitted when a diamond's constructor function or function from a facet makes a `delegatecall`.
    </div>

    <div style={{marginBottom: "1rem"}}>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
{`event DiamondDelegateCall(address indexed _delegate, bytes _functionCall);`}
      </ExpandableCode>
    </div>

    <div style={{marginBottom: "1rem"}}>
      <strong>Parameters:</strong>
      <PropertyTable
        properties={[
          {
            name: "_delegate",
            type: "address",
            description: "The contract that was delegatecalled."
          },
          {
            name: "_functionCall",
            type: "bytes",
            description: "The function call, including function selector and any arguments."
          }
        ]}
        showRequired={false}
      />
    </div>
  </Accordion>
  <Accordion title="DiamondFunctionAdded" defaultOpen={false}>
    <div style={{marginBottom: "1rem"}}>
      Emitted when a function is added to a diamond.
    </div>

    <div style={{marginBottom: "1rem"}}>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
{`event DiamondFunctionAdded(bytes4 indexed _selector, address indexed _facet);`}
      </ExpandableCode>
    </div>

    <div style={{marginBottom: "1rem"}}>
      <strong>Parameters:</strong>
      <PropertyTable
        properties={[
          {
            name: "_selector",
            type: "bytes4",
            description: "The function selector being added."
          },
          {
            name: "_facet",
            type: "address",
            description: "The facet address that will handle calls to `_selector`."
          }
        ]}
        showRequired={false}
      />
    </div>
  </Accordion>
  <Accordion title="DiamondFunctionRemoved" defaultOpen={false}>
    <div style={{marginBottom: "1rem"}}>
      Emitted when a function is removed from a diamond.
    </div>

    <div style={{marginBottom: "1rem"}}>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
{`event DiamondFunctionRemoved(bytes4 indexed _selector, address indexed _oldFacet);`}
      </ExpandableCode>
    </div>

    <div style={{marginBottom: "1rem"}}>
      <strong>Parameters:</strong>
      <PropertyTable
        properties={[
          {
            name: "_selector",
            type: "bytes4",
            description: "The function selector being removed."
          },
          {
            name: "_oldFacet",
            type: "address",
            description: "The facet address that previously handled `_selector`."
          }
        ]}
        showRequired={false}
      />
    </div>
  </Accordion>
  <Accordion title="DiamondFunctionReplaced" defaultOpen={false}>
    <div style={{marginBottom: "1rem"}}>
      Emitted when changing the facet that will handle calls to a function.
    </div>

    <div style={{marginBottom: "1rem"}}>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
{`event DiamondFunctionReplaced(bytes4 indexed _selector, address indexed _oldFacet, address indexed _newFacet);`}
      </ExpandableCode>
    </div>

    <div style={{marginBottom: "1rem"}}>
      <strong>Parameters:</strong>
      <PropertyTable
        properties={[
          {
            name: "_selector",
            type: "bytes4",
            description: "The function selector being affected."
          },
          {
            name: "_oldFacet",
            type: "address",
            description: "The facet address previously responsible for `_selector`."
          },
          {
            name: "_newFacet",
            type: "address",
            description: "The facet address that will now handle calls to `_selector`."
          }
        ]}
        showRequired={false}
      />
    </div>
  </Accordion>
  <Accordion title="DiamondMetadata" defaultOpen={false}>
    <div style={{marginBottom: "1rem"}}>
      Emitted to record information about a diamond. This event records any arbitrary metadata. The format of `_tag` and `_data` are not specified by the standard.
    </div>

    <div style={{marginBottom: "1rem"}}>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
{`event DiamondMetadata(bytes32 indexed _tag, bytes _data);`}
      </ExpandableCode>
    </div>

    <div style={{marginBottom: "1rem"}}>
      <strong>Parameters:</strong>
      <PropertyTable
        properties={[
          {
            name: "_tag",
            type: "bytes32",
            description: "Arbitrary metadata, such as a release version."
          },
          {
            name: "_data",
            type: "bytes",
            description: "Arbitrary metadata."
          }
        ]}
        showRequired={false}
      />
    </div>
  </Accordion>
</AccordionGroup>

## Errors

<AccordionGroup>
  <Accordion title="CannotAddFunctionToDiamondThatAlreadyExists" defaultOpen={false}>

    <div>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
error CannotAddFunctionToDiamondThatAlreadyExists(bytes4 _selector);
      </ExpandableCode>
    </div>
  </Accordion>
  <Accordion title="CannotRemoveFunctionThatDoesNotExist" defaultOpen={false}>

    <div>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
error CannotRemoveFunctionThatDoesNotExist(bytes4 _selector);
      </ExpandableCode>
    </div>
  </Accordion>
  <Accordion title="CannotRemoveImmutableFunction" defaultOpen={false}>

    <div>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
error CannotRemoveImmutableFunction(bytes4 _selector);
      </ExpandableCode>
    </div>
  </Accordion>
  <Accordion title="CannotReplaceFunctionThatDoesNotExist" defaultOpen={false}>

    <div>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
error CannotReplaceFunctionThatDoesNotExist(bytes4 _selector);
      </ExpandableCode>
    </div>
  </Accordion>
  <Accordion title="CannotReplaceFunctionWithTheSameFacet" defaultOpen={false}>

    <div>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
error CannotReplaceFunctionWithTheSameFacet(bytes4 _selector);
      </ExpandableCode>
    </div>
  </Accordion>
  <Accordion title="CannotReplaceImmutableFunction" defaultOpen={false}>

    <div>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
error CannotReplaceImmutableFunction(bytes4 _selector);
      </ExpandableCode>
    </div>
  </Accordion>
  <Accordion title="DelegateCallReverted" defaultOpen={false}>

    <div>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
error DelegateCallReverted(address _delegate, bytes _functionCall);
      </ExpandableCode>
    </div>
  </Accordion>
  <Accordion title="NoBytecodeAtAddress" defaultOpen={false}>

    <div>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
error NoBytecodeAtAddress(address _contractAddress);
      </ExpandableCode>
    </div>
  </Accordion>
  <Accordion title="NoSelectorsProvidedForFacet" defaultOpen={false}>
    <div style={{marginBottom: "1rem"}}>
      The functions below detect and revert with the following errors.
    </div>

    <div>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
error NoSelectorsProvidedForFacet(address _facet);
      </ExpandableCode>
    </div>
  </Accordion>
</AccordionGroup>

<!-- Usage Example section commented out for now -->
<!--
## Usage Example

<ExpandableCode language="solidity" maxLines={20} title="Example Implementation">
{`pragma solidity >=0.8.30;

import @compose/diamond/DiamondUpgradeMod;
import { FacetFunctions } from "@compose/diamond/DiamondUpgradeMod";

contract MyDiamondUpgradeFacet {
    DiamondUpgradeMod internal diamondUpgradeMod;

    constructor(address _diamondUpgradeMod) {
        diamondUpgradeMod = DiamondUpgradeMod(_diamondUpgradeMod);
    }

    function exampleUpgrade() external {
        FacetFunctions[] memory addFuncs = new FacetFunctions[](1);
        addFuncs[0] = FacetFunctions({
            facetAddress: address(this),
            functionSelectors: new bytes4[](1)
        });
        addFuncs[0].functionSelectors[0] = this.exampleUpgrade.selector;

        bytes4[] memory removeFuncs = new bytes4[](0);
        FacetFunctions[] memory replaceFuncs = new FacetFunctions[](0);

        diamondUpgradeMod.upgradeDiamond(
            addFuncs,
            replaceFuncs,
            removeFuncs,
            address(0), // No delegate call for this example
            "",
            bytes32(0), // No tag
            ""
        );
    }

    function internalUpgradeDiamond(
        FacetFunctions[] memory _addFunctions,
        FacetFunctions[] memory _replaceFunctions,
        bytes4[] memory _removeFunctions,
        address _delegate,
        bytes memory _functionCall,
        bytes32 _tag,
        bytes memory _metadata
    ) external {
        diamondUpgradeMod.upgradeDiamond(
            _addFunctions,
            _replaceFunctions,
            _removeFunctions,
            _delegate,
            _functionCall,
            _tag,
            _metadata
        );
    }
}`}
</ExpandableCode>
-->

## Best Practices

<Callout type="tip" title="Best Practice">
- Ensure that only authorized entities call `upgradeDiamond` to prevent unauthorized changes.
- Verify that function selectors and facet addresses are correctly specified before initiating an upgrade.
- Handle potential `DelegateCallReverted` errors when a `delegatecall` is performed as part of the upgrade process.
</Callout>

## Integration Notes

<Callout type="success" title="Shared Storage">
This module interacts with diamond storage via the `DIAMOND_STORAGE_POSITION` using the `keccak256("erc8109.diamond")` value. The `DiamondStorage` struct, though empty in the provided definition, is the conceptual root for diamond state. Functions like `addFunctions`, `removeFunctions`, `replaceFunctions`, and `upgradeDiamond` directly manipulate the diamond's function selector mappings stored within the diamond's storage. Changes are immediately visible to all facets interacting with the diamond.
</Callout>

<div style={{marginTop: "3rem", paddingTop: "2rem", borderTop: "1px solid var(--ifm-color-emphasis-200)"}}>
  <RelatedDocs
    items={[
      {
        title: "DiamondUpgradeFacet",
        href: "/docs/library/diamond/DiamondUpgradeFacet",
        description: "Facet using DiamondUpgradeMod",
        icon: "ðŸ’Ž"
      },
      {
        title: "DiamondMod",
        href: "/docs/library/diamond/DiamondMod",
        description: "Related module in diamond",
        icon: "ðŸ“¦"
      }
    ]}
  />
</div>

<div style={{marginTop: "3rem", paddingTop: "2rem", borderTop: "1px solid var(--ifm-color-emphasis-200)"}}>
  <WasThisHelpful pageId="DiamondUpgradeMod" />
</div>

<LastUpdated date="2025-12-30T18:43:21.762Z" />
