---
sidebar_position: 99
title: "ERC20PermitFacet"
description: "Manages ERC-20 token allowances via EIP-2612 permit signatures."
gitSource: "https://github.com/maxnorm/Compose/blob/7e2dd824639f424be644c4ebbb3ca2508167329f/src/token/ERC20/ERC20Permit/ERC20PermitFacet.sol"
---

import DocSubtitle  from '@site/src/components/docs/DocSubtitle';
import Badge from '@site/src/components/ui/Badge';
import Callout from '@site/src/components/ui/Callout';
import CalloutBox from '@site/src/components/ui/CalloutBox';
import Accordion, { AccordionGroup } from '@site/src/components/ui/Accordion';
import PropertyTable from '@site/src/components/api/PropertyTable';
import ExpandableCode from '@site/src/components/code/ExpandableCode';
import CodeShowcase from '@site/src/components/code/CodeShowcase';
import RelatedDocs from '@site/src/components/docs/RelatedDocs';
import WasThisHelpful from '@site/src/components/docs/WasThisHelpful';
import LastUpdated from '@site/src/components/docs/LastUpdated';
import ReadingTime from '@site/src/components/docs/ReadingTime';
import GradientText from '@site/src/components/ui/GradientText';
import GradientButton from '@site/src/components/ui/GradientButton';

<DocSubtitle>
Manages ERC-20 token allowances via EIP-2612 permit signatures.
</DocSubtitle>

<Callout type="info" title="Key Features">
- Implements EIP-2612 permit functionality for ERC-20 tokens.
- Provides `nonces` and `DOMAIN_SEPARATOR` to support signature generation.
- Enables gas-less approvals by allowing off-chain signature verification.
</Callout>

## Overview

The ERC20PermitFacet enables EIP-2612 compliant off-chain approvals for ERC-20 tokens within a Compose diamond. It allows token owners to grant allowances to spenders using signed messages, bypassing on-chain transactions for approval. This enhances user experience by reducing gas costs and improving flexibility.

---

## Storage

### ERC20Storage

<ExpandableCode language="solidity" maxLines={15} title="Definition">
{`struct ERC20Storage {
    mapping(address owner => uint256 balance) balanceOf;
    uint256 totalSupply;
    mapping(address owner => mapping(address spender => uint256 allowance)) allowance;
    uint8 decimals;
    string name;
}`}
</ExpandableCode>

---
### ERC20PermitStorage

<ExpandableCode language="solidity" maxLines={15} title="Definition">
{`struct ERC20PermitStorage {
    mapping(address owner => uint256) nonces;
}`}
</ExpandableCode>

### State Variables

<PropertyTable
  properties={[
    {
      name: "ERC20_STORAGE_POSITION",
      type: "constant",
      description: "Diamond storage slot position for this module"
    },
    {
      name: "STORAGE_POSITION",
      type: "constant",
      description: "Diamond storage slot position for this module"
    }
  ]}
  showRequired={false}
/>

## Functions

### getERC20Storage

<ExpandableCode language="solidity" maxLines={8}>
{`function getERC20Storage() internal pure returns (ERC20Storage storage s);`}
</ExpandableCode>

---
### getStorage

<ExpandableCode language="solidity" maxLines={8}>
{`function getStorage() internal pure returns (ERC20PermitStorage storage s);`}
</ExpandableCode>

---
### nonces

Returns the current nonce for an owner. This value changes each time a permit is used.

<ExpandableCode language="solidity" maxLines={8}>
{`function nonces(address _owner) external view returns (uint256);`}
</ExpandableCode>

**Parameters:**

<PropertyTable
  properties={[
    {
      name: "_owner",
      type: "address",
      description: "The address of the owner."
    }
  ]}
  showRequired={false}
/>

**Returns:**

<PropertyTable
  properties={[
    {
      name: "-",
      type: "uint256",
      description: "The current nonce."
    }
  ]}
  showRequired={false}
/>

---
### DOMAIN_SEPARATOR

Returns the domain separator used in the encoding of the signature for permit. This value is unique to a contract and chain ID combination to prevent replay attacks.

<ExpandableCode language="solidity" maxLines={8}>
{`function DOMAIN_SEPARATOR() external view returns (bytes32);`}
</ExpandableCode>

**Returns:**

<PropertyTable
  properties={[
    {
      name: "-",
      type: "bytes32",
      description: "The domain separator."
    }
  ]}
  showRequired={false}
/>

---
### permit

Sets the allowance for a spender via a signature. This function implements EIP-2612 permit functionality.

<ExpandableCode language="solidity" maxLines={8}>
{`function permit(
    address _owner,
    address _spender,
    uint256 _value,
    uint256 _deadline,
    uint8 _v,
    bytes32 _r,
    bytes32 _s
) external;`}
</ExpandableCode>

**Parameters:**

<PropertyTable
  properties={[
    {
      name: "_owner",
      type: "address",
      description: "The address of the token owner."
    },
    {
      name: "_spender",
      type: "address",
      description: "The address of the spender."
    },
    {
      name: "_value",
      type: "uint256",
      description: "The amount of tokens to approve."
    },
    {
      name: "_deadline",
      type: "uint256",
      description: "The deadline for the permit (timestamp)."
    },
    {
      name: "_v",
      type: "uint8",
      description: "The recovery byte of the signature."
    },
    {
      name: "_r",
      type: "bytes32",
      description: "The r value of the signature."
    },
    {
      name: "_s",
      type: "bytes32",
      description: "The s value of the signature."
    }
  ]}
  showRequired={false}
/>

## Events

<AccordionGroup>
  <Accordion title="Approval" defaultOpen={false}>
    <div style={{marginBottom: "1rem"}}>
      Emitted when an approval is made for a spender by an owner.
    </div>

    <div style={{marginBottom: "1rem"}}>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
{`event Approval(address indexed _owner, address indexed _spender, uint256 _value);`}
      </ExpandableCode>
    </div>

    <div style={{marginBottom: "1rem"}}>
      <strong>Parameters:</strong>
      <PropertyTable
        properties={[
          {
            name: "_owner",
            type: "address",
            description: "The address granting the allowance."
          },
          {
            name: "_spender",
            type: "address",
            description: "The address receiving the allowance."
          },
          {
            name: "_value",
            type: "uint256",
            description: "The amount approved."
          }
        ]}
        showRequired={false}
      />
    </div>
  </Accordion>
</AccordionGroup>

## Errors

<AccordionGroup>
  <Accordion title="ERC2612InvalidSignature" defaultOpen={false}>
    <div style={{marginBottom: "1rem"}}>
      Thrown when a permit signature is invalid or expired.
    </div>

    <div>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
error ERC2612InvalidSignature(
    address _owner, address _spender, uint256 _value, uint256 _deadline, uint8 _v, bytes32 _r, bytes32 _s
);
      </ExpandableCode>
    </div>
  </Accordion>
  <Accordion title="ERC20InvalidSpender" defaultOpen={false}>
    <div style={{marginBottom: "1rem"}}>
      Thrown when the spender address is invalid (e.g., zero address).
    </div>

    <div>
      <strong>Signature:</strong>
      <ExpandableCode language="solidity" maxLines={5}>
error ERC20InvalidSpender(address _spender);
      </ExpandableCode>
    </div>
  </Accordion>
</AccordionGroup>

## Usage Example

<ExpandableCode language="solidity" maxLines={20} title="Example Implementation">
{`pragma solidity ^0.8.30;

import {IERC20Permit } from "@openzeppelin/contracts/token/ERC20/extensions/draft-IERC20Permit.sol";
import { ERC20PermitFacet } from "./ERC20PermitFacet.sol";

contract MyDiamond {
    // Assume diamond deployment and facet registration are handled elsewhere

    ERC20PermitFacet private erc20PermitFacet;

    function setERC20PermitFacet(address _facetAddress) external {
        erc20PermitFacet = ERC20PermitFacet(_facetAddress);
    }

    // Example: Using permit to approve a spender
    function approveWithPermit(address tokenAddress, address spender, uint256 amount, uint256 deadline, bytes calldata signature) external {
        // Ensure the ERC20PermitFacet is correctly initialized and has the permit function
        // In a real scenario, you might use a Diamond Loupe facet to get function selectors

        // Call the permit function via the diamond proxy
        // Note: The actual call would be routed by the diamond proxy to the registered facet
        // This example directly calls the facet for demonstration purposes.
        erc20PermitFacet.permit(tokenAddress, msg.sender, spender, amount, deadline, signature);
    }
}

// Example of generating a permit signature (off-chain)
// require(block.timestamp <= deadline);
// bytes32 domainSeparator = erc20PermitFacet.DOMAIN_SEPARATOR();
// uint256 nonce = erc20PermitFacet.nonces(owner);
// bytes32 digest = keccak256(
//     abi.encode(
//         keccak256("Permit(address owner,address spender,uint256 value,uint256 nonce,uint256 deadline)"),
//         owner,
//         spender,
//         amount,
//         nonce,
//         deadline
//     )
// );
// signature = vm.sign(ownerPrivateKey, digest);`}
</ExpandableCode>

## Best Practices

<Callout type="tip" title="Best Practice">
- Initialize the `ERC20PermitFacet` with the correct ERC-20 token contract address during diamond deployment or upgrade.
- Ensure the `deadline` provided in the `permit` call is valid and has not passed.
- Securely manage the private keys used for signing permit messages off-chain.
</Callout>

## Security Considerations

<Callout type="warning" title="Security">
The `permit` function relies on the signature's validity, which is checked against the owner's nonce and the domain separator. Ensure the `deadline` parameter is strictly enforced to prevent stale permits. The function itself does not have reentrancy risks as it does not make external calls. Access control is implicitly managed by the signature verification; only the `owner` can permit an allowance.
</Callout>

<div style={{marginTop: "3rem", paddingTop: "2rem", borderTop: "1px solid var(--ifm-color-emphasis-200)"}}>
  <WasThisHelpful pageId="ERC20PermitFacet" />
</div>

<LastUpdated date="2025-12-21T21:53:58.488Z" />
